# Deutsch Trainer (DE Word Trainer)

Приложение для изучения немецкого языка с фокусом на глаголы, их спряжения и примеры использования.

## Описание проекта

Deutsch Trainer – это веб-приложение для эффективного изучения немецкого языка. Основные возможности:

- Изучение немецких глаголов и их спряжений
- Просмотр примеров использования глаголов в предложениях
- Поддержка разных времен и форм глаголов
- Мультиязычные переводы (поддержка русского и других языков)
- Система пользователей с аутентификацией
- Избранные глаголы и персональные списки
- Административная панель

## Технологии

- **Backend**: Node.js, Express.js
- **База данных**: MongoDB, Mongoose
- **Frontend**: EJS, JavaScript, CSS
- **Сборка**: Webpack
- **Безопасность**: JWT, bcrypt
- **Тестирование**: Mocha, Chai, Supertest
- **Качество кода**: ESLint, nyc (покрытие тестами)

## Установка и запуск

### Предварительные требования

- Node.js (версия 14 или выше)
- MongoDB (запущенный локально или удаленно)
- npm

### Шаги по установке

1. Клонирование репозитория:
   ```bash
   git clone <ссылка-на-репозиторий>
   cd de.loc
   ```

2. Установка зависимостей:
   ```bash
   npm install
   ```

3. Настройка переменных окружения:
   - Создайте файл `.env` в корне проекта на основе имеющегося файла
   - Укажите необходимые параметры (URL для БД, секретные ключи и т.д.)
   
   **Обязательные переменные:**
   ```env
   ## App Settings
   APP_NAME='Deutsch Trainer'
   APP_ENV=development
   APP_DEBUG=true

   ## MongoDB Settings
   MONGO_URI=mongodb://localhost:27017/deVerbsApp

   ## JWT Authentication Settings (КРИТИЧНО!)
   JWT_SECRET=your-super-secret-jwt-key-for-development-only-change-in-production
   JWT_EXPIRES_IN=1d

   ## Node.js Settings
   NODE_PORT=3000
   NODE_ENV=development

   ## Alphabet Filter On/Off
   ENABLE_LETTER_FILTER=true
   ```

4. **Проверка конфигурации системы:**
   ```bash
   npm run health-check
   ```
   Этот скрипт проверит:
   - Загрузку всех переменных окружения
   - Функциональность JWT (создание и верификация токенов)
   - Подключение к базе данных MongoDB

5. Сборка фронтенда:
   ```bash
   npm run build
   ```

6. Запуск приложения:
   - Для продакшена:
     ```bash
     npm start
     ```
   - Для разработки:
     ```bash
     npm run dev
     ```

7. Заполнение базы данных (опционально):
   ```bash
   npm run seed-verbs_sentences-a-present-ru
   ```

### Тестирование

8. Запуск всех тестов:
   ```bash
   npm test
   ```
   **Результат:** 87 passing тестов (100% success rate)

9. Запуск специфических групп тестов:
   ```bash
   npm run test:unit          # Тесты моделей и middleware
   npm run test:api           # Тесты API маршрутов
   npm run test:integration   # Интеграционные тесты
   npm run test:auth          # Тесты аутентификации
   npm run test:user          # Тесты пользователей
   ```

10. Проверка покрытия тестов:
    ```bash
    npm run test:coverage
    ```
    Показывает, какая часть кода покрыта тестами (используется nyc).

11. Проверка кода линтером:
    ```bash
    npm run lint
    ```
    Проверяет проект на соответствие стандартам кода (используется ESLint).

12. Автоматическая правка кода линтером:
    ```bash
    npm run lint -- --fix
    ```
    Автоматически исправляет простые ошибки форматирования и стиля кода.

### Управление базой данных

13. Полный импорт данных из папки `!db`:
    ```bash
    npm run import:full
    ```
    Импортирует все доступные файлы глаголов из папки `!db` в базу данных MongoDB. 
    Автоматически определяет типы файлов и импортирует их в правильном порядке.
    
    Опции:
    - `npm run import:full -- --verbose` - подробный вывод
    - `npm run import:full -- --silent` - минимальный вывод
    - `npm run import:full -- --no-clear` - не очищать существующие данные

14. Очистка базы данных:
    ```bash
    npm run clean:db
    ```
    ⚠️ **ВНИМАНИЕ**: Удаляет ВСЕ данные глаголов из MongoDB! 
    Файлы в папке `!db` НЕ затрагиваются.
    
    Опции:
    - `npm run clean:db -- --force` - пропустить подтверждение (опасно!)

15. Просмотр статистики базы данных:
    ```bash
    npm run db:stats
    ```
    Показывает статистику по количеству записей в базе данных для каждой буквы и типа данных.

### Структура данных в папке `!db`

Папка `!db` содержит JSON файлы с данными глаголов, организованные по буквам алфавита:

- `de_verbs_{letter}.json` - основные глаголы
- `de_verbs_{letter}_translations_ru.json` - переводы на русский
- `de_verbs_{letter}_tenses_{tense}.json` - спряжения для времени
- `de_verbs_{letter}_sentences_{tense}.json` - примеры предложений
- `de_verbs_{letter}_sentences_{tense}_ru.json` - переводы предложений

Где:
- `{letter}` - буква алфавита (a-z, ae, oe, ue, ss)
- `{tense}` - время глагола (present, past_simple, past_perfect)

Система импорта автоматически определяет доступные файлы и импортирует только те, которые соответствуют конфигурации приложения.

## Структура проекта

```
├── config/             # Конфигурационные файлы
├── middleware/         # Middleware функции
│   ├── auth/          # Аутентификация (JWT)
│   └── error/         # Обработка ошибок
├── models/             # Mongoose модели
│   ├── user.js        # Модель пользователя
│   ├── userFavorites.js # Избранные глаголы
│   ├── userVerbLists.js # Пользовательские списки
│   └── verb.js        # Модели глаголов
├── public/             # Статические файлы
├── routes/             # Маршруты API и приложения
│   ├── auth/          # Аутентификация
│   ├── user/          # Пользовательские функции
│   ├── admin/         # Административная панель
│   └── verbs/         # Работа с глаголами
├── seeds/              # Скрипты для заполнения базы данных
├── test/               # Тесты (87 passing)
│   ├── integration/   # Интеграционные тесты
│   ├── middleware/    # Тесты middleware
│   ├── models/        # Тесты моделей
│   ├── routes/        # Тесты API
│   ├── setup/         # Настройка тестовой среды
│   └── utils/         # Тестовые утилиты и диагностика
│       └── env-checker.js # Диагностика системы
├── utils/              # Вспомогательные функции
│   ├── auth/          # Утилиты аутентификации
│   └── ...            # Другие утилиты
├── views/              # EJS шаблоны
├── .env                # Переменные окружения
├── db.js               # Подключение к базе данных
├── server.js           # Основной файл приложения
└── webpack.config.js   # Конфигурация Webpack
```

## Текущее состояние разработки

### ✅ Полностью реализовано
- **Базовая структура приложения** - Express.js сервер с EJS шаблонами
- **Модели данных** - User, UserFavorites, UserVerbLists, UserVerbListItems, Verb
- **Полная система аутентификации** - регистрация, логин, JWT токены
- **API для работы с глаголами** - CRUD операции, поиск, фильтрация
- **Пользовательские функции** - избранное, персональные списки глаголов
- **Административная панель** - управление пользователями и контентом
- **Система тестирования** - 87 passing тестов (100% success rate)
- **Диагностика системы** - автоматическая проверка конфигурации

### 🔧 Недавно исправлено (Январь 2025)

#### **Критические исправления аутентификации:**
1. **Проблема двойного хеширования паролей** ✅
   - **Проблема:** Пароли хешировались дважды (в контроллере + в модели)
   - **Решение:** Убрано ручное хеширование из контроллера регистрации
   - **Результат:** Логин теперь работает корректно

2. **Отсутствие JWT переменных окружения** ✅
   - **Проблема:** `JWT_SECRET` не был определен в .env
   - **Решение:** Добавлены `JWT_SECRET` и `JWT_EXPIRES_IN` в .env
   - **Результат:** JWT токены генерируются и проверяются правильно

3. **Проблемы с накоплением данных в тестах** ✅
   - **Проблема:** Тесты влияли друг на друга из-за остаточных данных
   - **Решение:** Добавлен `beforeEach` hook для очистки данных между тестами
   - **Результат:** Каждый тест выполняется в изолированной среде

#### **Улучшения инфраструктуры:**
4. **Система диагностики** ✅
   - **Добавлено:** Скрипт `test/utils/env-checker.js` для проверки конфигурации
   - **Команда:** `npm run health-check`
   - **Функции:** Проверка переменных окружения, JWT, подключения к БД

5. **Улучшенная документация** ✅
   - **Обновлен:** README.md с подробными инструкциями
   - **Добавлено:** Описание всех npm скриптов
   - **Добавлено:** Руководство по устранению неполадок

### 📊 Статистика тестирования

**До исправлений:**
- 81 passing, 6 failing
- Критические проблемы с аутентификацией
- Integration тесты не работали

**После исправлений:**
- ✅ **87 passing, 0 failing (100% success rate)**
- ✅ Все системы аутентификации работают
- ✅ Полная функциональность API
- ✅ Стабильные интеграционные тесты

### 🚀 В разработке
- Улучшение пользовательского интерфейса
- Расширение базы глаголов и примеров
- Добавление новых упражнений и тестов
- Интеграция с другими языковыми API

### 📋 Планируется
- Мобильная версия приложения
- Расширенная статистика для пользователей
- Система достижений и мотивации
- Интеграция с системами распознавания речи

## Основные пакеты и их назначение

- **express**: Веб-фреймворк для Node.js
- **mongoose**: ODM для работы с MongoDB
- **ejs**: Шаблонизатор для генерации HTML
- **bcrypt**: Хеширование паролей
- **jsonwebtoken**: Аутентификация через токены
- **dotenv**: Загрузка переменных окружения
- **method-override**: Поддержка PUT, DELETE запросов через формы
- **webpack**: Сборка frontend ресурсов
- **mocha & chai**: Тестирование
- **supertest**: HTTP тестирование
- **nyc**: Анализ покрытия тестами
- **eslint**: Линтинг и проверка качества кода

## Области применения

- Индивидуальное изучение немецкого языка
- Использование в образовательных учреждениях
- Подготовка к экзаменам и сертификации по немецкому языку
- Расширение словарного запаса и практика использования глаголов

## 🛠️ Диагностика и устранение неполадок

### Быстрая диагностика системы
```bash
npm run health-check
```

Этот скрипт автоматически проверит:
- ✅ Загрузку всех критических переменных окружения
- ✅ Функциональность JWT (создание и верификация токенов)
- ✅ Подключение к базе данных MongoDB

### Типичные проблемы и решения

#### 1. Ошибка "secretOrPrivateKey must have a value"
**Причина:** Отсутствует `JWT_SECRET` в .env файле
**Решение:**
```env
JWT_SECRET=your-super-secret-jwt-key-for-development-only-change-in-production
JWT_EXPIRES_IN=1d
```

#### 2. Ошибка подключения к MongoDB
**Причина:** MongoDB не запущен или неверный URI
**Решение:**
1. Убедитесь что MongoDB запущен
2. Проверьте `MONGO_URI` в .env файле
3. Запустите `npm run health-check` для диагностики

#### 3. Failing тесты
**Причина:** Проблемы с конфигурацией или базой данных
**Решение:**
1. Запустите `npm run health-check`
2. Убедитесь что тестовая БД доступна
3. Проверьте переменные окружения

#### 4. Проблемы с аутентификацией
**Причина:** Неправильная конфигурация JWT
**Решение:**
1. Проверьте наличие `JWT_SECRET` в .env
2. Убедитесь что пароли не хешируются дважды
3. Запустите тесты аутентификации: `npm run test:auth`

## Автор

Maksym Lyubachevsky (m.lyubachevsky@gmail.com)

## Лицензия

ISC

## 🎯 Заключение

Deutsch Trainer - это полнофункциональное веб-приложение для изучения немецкого языка с современной архитектурой, полным покрытием тестами и надежной системой аутентификации. Все критические проблемы исправлены, система стабильна и готова к использованию. 